<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PhoneticDoc Editor (Hanging Indent Ver.)</title>
    <style>
        /* --- 全局变量 --- */
        :root {
            --primary: #6366f1;
            --primary-light: #e0e7ff;
            --primary-hover: #4f46e5;
            --text-main: #334155;
            --text-light: #64748b;
            --bg-body: #f1f5f9;
            --bg-sidebar: #ffffff;
            --border: #e2e8f0;
            --radius: 10px;
            
            /* 动态样式变量 */
            --doc-line-height: 1.6;
            /* 块间距变量 */
            --block-margin: 0.6em; 
        }

        /* --- 美化滚动条 --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        * { box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; padding: 0; 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
        }

        /* --- 通用组件 --- */
        .hidden { display: none !important; }
        
        button { cursor: pointer; border: none; background: transparent; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-family: inherit; }
        
        .btn-icon { padding: 6px; border-radius: 6px; color: #94a3b8; width: 32px; height: 32px; }
        .btn-icon:hover { background: var(--primary-light); color: var(--primary); }
        .btn-icon.delete:hover { background: #fee2e2; color: #ef4444; }

        .sidebar-footer-btn {
            background: white; border: 1px solid var(--border); color: var(--text-main);
            padding: 10px; border-radius: var(--radius); font-size: 0.85rem; font-weight: 500;
            display: flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .sidebar-footer-btn:hover { border-color: var(--primary); color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }

        .btn-ghost-dashed { 
            color: var(--text-light); padding: 10px; font-size: 0.85rem; border-radius: var(--radius); 
            border: 1px dashed #cbd5e1; background: #f8fafc; margin-bottom: 8px; width: 100%;
        }
        .btn-ghost-dashed:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }

        .btn-big-primary { 
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); 
            color: white; padding: 12px; border-radius: var(--radius); 
            font-weight: 600; font-size: 1rem; width: 100%;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            letter-spacing: 1px;
        }
        .btn-big-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4); }

        /* 工具栏控件 */
        .toolbar-group { display: flex; align-items: center; gap: 8px; border-right: 1px solid var(--border); padding-right: 12px; margin-right: 12px; height: 24px; }
        .toolbar-group:last-child { border-right: none; }
        
        .color-picker-wrapper { display: flex; align-items: center; gap: 4px; cursor: pointer; padding: 4px; border-radius: 4px; transition: 0.2s; }
        .color-picker-wrapper:hover { background: #f1f5f9; }
        input[type="color"] { border: none; width: 20px; height: 20px; padding: 0; background: none; cursor: pointer; }
        input[type="range"] { width: 80px; accent-color: var(--primary); cursor: pointer; }
        
        /* 帮助提示气泡 */
        .tooltip-container { position: relative; }
        .tooltip-content {
            position: absolute; top: 100%; right: 0; margin-top: 15px; width: 300px;
            background: white; border: 1px solid var(--border); border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15); padding: 20px;
            z-index: 9999; 
            opacity: 0; visibility: hidden; transition: 0.2s;
            transform: translateY(-5px);
        }
        .tooltip-content::before {
            content: ''; position: absolute; top: -6px; right: 14px;
            width: 12px; height: 12px; background: white; border-top: 1px solid var(--border); border-left: 1px solid var(--border);
            transform: rotate(45deg);
        }
        .tooltip-container:hover .tooltip-content { opacity: 1; visibility: visible; transform: translateY(0); }
        .shortcut-row { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: var(--text-light); align-items: center; }
        .shortcut-key { 
            background: #f1f5f9; padding: 2px 8px; border-radius: 4px; 
            font-family: 'Menlo', monospace; color: var(--text-main); font-weight: 600; 
            border: 1px solid #e2e8f0; font-size: 0.75rem;
        }

        /* --- 侧边栏 --- */
        .sidebar { 
            width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); 
            display: flex; flex-direction: column; flex-shrink: 0; z-index: 20; 
        }
        .sidebar-header { 
            padding: 1.5rem; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; gap: 8px; 
            color: var(--primary); font-weight: 800; font-size: 1.2rem; 
        }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 1rem; }
        .sidebar-footer { 
            padding: 1.2rem; border-top: 1px solid var(--border); 
            background: #fafbff; 
            display: flex; flex-direction: column; gap: 10px; 
        }

        .chapter-item { margin-bottom: 1rem; }
        .chapter-header { display: flex; align-items: center; justify-content: space-between; padding: 4px 8px; margin-bottom: 4px; }
        .chapter-title { font-weight: 700; color: #1e293b; font-size: 0.9rem; border:none; background:transparent; width: 100%; outline: none; }
        .chapter-title:focus { background: #f1f5f9; border-radius: 4px; }
        .section-list { margin-left: 8px; padding-left: 8px; border-left: 2px solid #f1f5f9; display: flex; flex-direction: column; gap: 2px; }
        .section-item { 
            padding: 6px 10px; border-radius: 6px; font-size: 0.85rem; color: var(--text-light); cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;
        }
        .section-item:hover { background: #f8fafc; color: var(--text-main); }
        .section-item.active { background: var(--primary-light); color: var(--primary); font-weight: 600; }
        .section-actions, .chapter-actions { opacity: 0; }
        .section-item:hover .section-actions, .chapter-header:hover .chapter-actions { opacity: 1; }

        /* --- 主工作区 --- */
        .workspace { flex: 1; display: flex; flex-direction: column; background: #fff; min-width: 0; }
        .topbar { 
            height: 60px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; padding: 0 20px; 
            justify-content: space-between; flex-shrink: 0; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(5px);
            z-index: 50; 
        }
        .breadcrumb { display: flex; align-items: center; gap: 8px; flex: 1; margin-right: 20px; }
        .sec-title-input { font-size: 1rem; font-weight: 700; color: var(--text-main); border:none; background:transparent; width: 200px; outline: none; }
        .sec-title-input:focus { border-bottom: 1px solid var(--primary); }

        .editor-controls { display: flex; align-items: center; font-size: 0.85rem; color: var(--text-light); }
        .view-switch { background: #f1f5f9; padding: 2px; border-radius: 6px; display: flex; gap: 2px; margin-left: 12px; }
        .view-btn { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; color: var(--text-light); }
        .view-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }

        .editor-container { flex: 1; display: flex; overflow: hidden; position: relative; z-index: 10; }
        .pane { flex: 1; height: 100%; display: flex; flex-direction: column; overflow: hidden; }
        .pane.editor { border-right: 1px solid var(--border); background: #fff; }
        .pane.preview { background: #f1f5f9; overflow-y: auto; padding: 30px; align-items: center; }
        
        textarea { 
            flex: 1; width: 100%; padding: 40px; border: none; outline: none; resize: none; 
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 15px; line-height: 1.7; color: #334155; 
        }

        /* --- Markdown 样式 (紧凑与美化版) --- */
        .paper-sheet {
            width: 100%; max-width: 820px; background: #ffffff; padding: 50px 70px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 4px; min-height: 80vh;
        }

        .markdown-body { 
            line-height: var(--doc-line-height);
            color: #1e293b; font-size: 16px; 
            transition: line-height 0.2s ease;
        }
        
        /* 标题 */
        .markdown-body h1 { font-size: 2.2em; font-weight: 800; border-bottom: 2px solid var(--primary-light); padding-bottom: 0.2em; margin: 0.6em 0 0.5em; color: #0f172a; }
        .markdown-body h2 { font-size: 1.6em; font-weight: 700; margin-top: 0.8em; margin-bottom: 0.4em; color: #334155; display: flex; align-items: center; }
        .markdown-body h2::before { content: ''; display: inline-block; width: 6px; height: 24px; background: var(--primary); margin-right: 10px; border-radius: 3px; }
        .markdown-body h3 { font-size: 1.3em; font-weight: 600; margin-top: 0.6em; margin-bottom: 0.3em; color: #475569; }
        .markdown-body h4 { font-size: 1.1em; font-weight: 600; margin-top: 0.5em; margin-bottom: 0.2em; color: #64748b; }
        
        /* 正文与引用 */
        .markdown-body p { margin-bottom: var(--block-margin); text-align: justify; }
        
        /* 列表优化 */
        .markdown-body ul, .markdown-body ol { margin-bottom: var(--block-margin); padding-left: 1.5em; color: #475569; }
        
        /* 表格样式 */
        .markdown-body table { border-collapse: collapse; width: 100%; margin-bottom: var(--block-margin); display: table; }
        .markdown-body th, .markdown-body td { border: 1px solid #e2e8f0; padding: 8px 12px; font-size: 0.95em; }
        .markdown-body th { background-color: #f8fafc; font-weight: 600; text-align: left; color: var(--text-main); }
        .markdown-body tr:nth-child(2n) { background-color: #fbfcfd; }
        .markdown-body tr:hover { background-color: #f1f5f9; }
        
        /* 引用块 */
        .markdown-body blockquote { border-left: 4px solid var(--primary); padding: 6px 16px; color: #64748b; background: #f8fafc; border-radius: 0 4px 4px 0; margin: var(--block-margin) 0; }
        
        /* 代码块 */
        .markdown-body pre { 
            background: #1e293b; color: #e2e8f0; 
            padding: 1rem; border-radius: 8px; overflow-x: auto; 
            margin: var(--block-margin) 0; 
            font-family: 'Menlo', 'Monaco', monospace; font-size: 0.9em;
        }
        .markdown-body pre code { background: transparent; color: inherit; padding: 0; }
        .markdown-body code { background: #f1f5f9; color: var(--primary); padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }

        .markdown-body hr { border: 0; border-top: 2px dashed #cbd5e1; margin: 1.5em 0; }
        .markdown-body img { max-width: 100%; border-radius: 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin: var(--block-margin) auto; display: block; }
        .markdown-body audio { width: 100%; margin: var(--block-margin) auto; display: block; }
        .markdown-body a { color: var(--primary); text-decoration: none; border-bottom: 1px dashed; }
        
        /* 特殊对齐 */
        .text-center, .text-right, .text-justify { margin-bottom: var(--block-margin); }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-justify { text-align: justify; }

        /* 拖拽上传 */
        .drag-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; opacity: 0; pointer-events: none; border: 4px dashed var(--primary); transition: opacity 0.2s;}
        .drag-overlay.active { opacity: 1; pointer-events: all; }

        .msg-toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #10b981; color: white; padding: 8px 24px; border-radius: 50px; font-weight: 600; opacity: 0; transition: all 0.3s; z-index: 200; pointer-events: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .msg-toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* 同步高亮 */
        .sync-active { 
            animation: highlight-pulse 2s ease-out; 
            border-left: 3px solid var(--primary);
            background: linear-gradient(to right, var(--primary-light), transparent);
        }
        @keyframes highlight-pulse {
            0% { background-color: var(--primary-light); }
            100% { background-color: transparent; }
        }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 0 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"></path></svg>
            PhoneticDoc
        </div>
        <div class="sidebar-content" id="chapterList"></div>
        <div class="sidebar-footer">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="sidebar-footer-btn" onclick="app.downloadJSON()" title="保存为本地文件">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    备份
                </button>
                <label class="sidebar-footer-btn" style="cursor: pointer;" title="从本地文件读取">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    恢复
                    <input type="file" hidden accept=".json" onchange="app.loadJSON(this)">
                </label>
            </div>
            
            <!-- 暂存按钮已移除，Ctrl+S 改为直接备份 -->
            
            <button class="btn-big-primary" onclick="app.exportHTML()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                导出网页
            </button>
        </div>
    </aside>

    <main class="workspace" id="workspace">
        <div class="topbar">
            <div class="breadcrumb">
                <span style="color:#cbd5e1; font-weight:700" id="headerChapTitle">...</span>
                <span style="color:#cbd5e1; margin:0 4px">/</span>
                <input type="text" class="sec-title-input" id="headerSecTitle" placeholder="小节标题">
            </div>

            <div class="editor-controls">
                <div class="toolbar-group">
                    <span title="行间距" style="cursor:help">↕</span>
                    <input type="range" min="1.0" max="3.0" step="0.1" value="1.6" id="lineHeightRange" oninput="app.updateLineHeight(this.value)" title="调整行间距">
                    <span id="lineHeightValue" style="width:30px; text-align:right">1.6</span>
                </div>
                <div class="toolbar-group">
                     <div class="color-picker-wrapper" title="选择文字颜色">
                        <span style="font-weight:bold; color:var(--text-light)">A</span>
                        <input type="color" id="textColorPicker" value="#000000" onchange="app.applyColor(this.value)">
                    </div>
                </div>
                <div class="toolbar-group tooltip-container">
                    <button class="btn-icon" style="color:var(--primary); font-weight:bold; background:#eef2ff">?</button>
                    <div class="tooltip-content">
                        <div style="font-weight:bold; margin-bottom:10px; color:var(--primary); display:flex; justify-content:space-between; align-items:center">
                            ⌨️ 快捷键秘籍
                            <span style="font-size:12px; font-weight:normal; color:#94a3b8">Ctrl+Z 可撤销格式</span>
                        </div>
                        <div class="shortcut-row"><span>加粗</span><span class="shortcut-key">Ctrl + B</span></div>
                        <div class="shortcut-row"><span>斜体</span><span class="shortcut-key">Ctrl + I</span></div>
                        <div class="shortcut-row"><span>下划线</span><span class="shortcut-key">Ctrl + U</span></div>
                        <div class="shortcut-row"><span>删除线</span><span class="shortcut-key">Ctrl + D</span></div>
                        <div class="shortcut-row"><span>插入链接</span><span class="shortcut-key">Ctrl + K</span></div>
                        <hr style="border:0; border-top:1px dashed #e2e8f0; margin:8px 0">
                        <div class="shortcut-row"><span>居左对齐</span><span class="shortcut-key">Ctrl + L</span></div>
                        <div class="shortcut-row"><span>居中对齐</span><span class="shortcut-key">Ctrl + E</span></div>
                        <div class="shortcut-row"><span>右对齐</span><span class="shortcut-key">Ctrl + R</span></div>
                        <div class="shortcut-row"><span>两端对齐</span><span class="shortcut-key">Ctrl + J</span></div>
                        <hr style="border:0; border-top:1px dashed #e2e8f0; margin:8px 0">
                        <div class="shortcut-row"><span>保存进度</span><span class="shortcut-key">Ctrl + S</span></div>
                    </div>
                </div>
                <div class="view-switch">
                    <button class="view-btn active" id="btnSplit" onclick="app.setView('split')">分栏</button>
                    <button class="view-btn" id="btnEdit" onclick="app.setView('edit')">编辑</button>
                    <button class="view-btn" id="btnPreview" onclick="app.setView('preview')">预览</button>
                </div>
            </div>
        </div>

        <div class="editor-container">
            <div class="drag-overlay" id="dragOverlay">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:1rem"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                松手上传图片或音频
            </div>
            
            <div class="pane editor" id="paneEditor">
                <textarea id="markdownInput" placeholder="# 笔记标题&#10;&#10;- 输入列表项，自动变得紧凑漂亮&#10;- 还可以按 Tab 键进行缩进哦！"></textarea>
            </div>
            <div class="pane preview" id="panePreview">
                <div class="paper-sheet">
                    <div class="markdown-body" id="previewContent"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="msg-toast" id="msgToast">保存成功</div>

    <script>
        // --- Markdown 解析器 (Line-Based for Sync) ---
        const SimpleMD = {
            parse: function(text) {
                if (!text) return '';
                const lines = text.split('\n');
                let html = '';
                let inCodeBlock = false;
                let codeBuffer = [];
                let listBuffer = [];
                let listType = null; // 'ul' or 'ol'
                let tableBuffer = [];
                
                const flushList = () => {
                    if (listBuffer.length === 0) return;
                    const tag = listType === 'ol' ? 'ol' : 'ul';
                    const items = listBuffer.map(item => {
                        // 去除标记符
                        let content = item.text.replace(/^(\s*)(-|\d+\.)\s+/, '');
                        return `<li data-line="${item.line}">${this.inlineParse(content)}</li>`;
                    }).join('');
                    html += `<${tag} style="margin-bottom: var(--block-margin);">${items}</${tag}>`;
                    listBuffer = [];
                    listType = null;
                };

                const flushTable = () => {
                    if (tableBuffer.length === 0) return;
                    // Check if valid table (at least header and separator)
                    // 简单判断：第二行包含 | 和 -
                    if (tableBuffer.length >= 2 && tableBuffer[1].text.includes('|') && tableBuffer[1].text.includes('-')) {
                        html += '<table><thead><tr>';
                        
                        const processRow = (rowStr) => {
                             let cells = rowStr.trim();
                             if (cells.startsWith('|')) cells = cells.substring(1);
                             if (cells.endsWith('|')) cells = cells.substring(0, cells.length - 1);
                             return cells.split('|');
                        };
                        
                        processRow(tableBuffer[0].text).forEach(h => html += `<th>${this.inlineParse(h.trim())}</th>`);
                        html += '</tr></thead><tbody>';
                        
                        for (let i = 2; i < tableBuffer.length; i++) {
                            html += `<tr data-line="${tableBuffer[i].line}">`;
                            processRow(tableBuffer[i].text).forEach(c => html += `<td>${this.inlineParse(c.trim())}</td>`);
                            html += '</tr>';
                        }
                        html += '</tbody></table>';
                    } else {
                        // Not a table, dump as paragraphs
                        tableBuffer.forEach(line => {
                            html += `<p data-line="${line.line}">${this.inlineParse(line.text)}</p>`;
                        });
                    }
                    tableBuffer = [];
                };

                lines.forEach((line, i) => {
                    const lineNum = i + 1;
                    const trimmed = line.trim();
                    
                    // Code Blocks
                    if (trimmed.startsWith('```')) {
                        if (inCodeBlock) {
                            html += `<pre data-line="${lineNum}"><code>${this.escapeHtml(codeBuffer.join('\n'))}</code></pre>`;
                            codeBuffer = [];
                            inCodeBlock = false;
                        } else {
                            if (listBuffer.length) flushList();
                            if (tableBuffer.length) flushTable();
                            inCodeBlock = true;
                        }
                        return; 
                    }
                    if (inCodeBlock) {
                        codeBuffer.push(line);
                        return;
                    }

                    // Lists
                    const ulMatch = line.match(/^(\s*)-\s+(.*)/);
                    const olMatch = line.match(/^(\s*)\d+\.\s+(.*)/);
                    
                    if (ulMatch || olMatch) {
                        if (tableBuffer.length) flushTable();
                        
                        const currentType = ulMatch ? 'ul' : 'ol';
                        
                        if (listBuffer.length > 0 && listType !== currentType) {
                            flushList();
                        }
                        
                        listType = currentType;
                        listBuffer.push({text: line, line: lineNum});
                        return;
                    } else {
                        if (listBuffer.length) flushList();
                    }

                    // Tables
                    // 简单判断：行中包含 |
                    if (trimmed.startsWith('|') || (trimmed.includes('|') && tableBuffer.length > 0)) {
                         tableBuffer.push({text: line, line: lineNum});
                         return;
                    } else {
                         if (tableBuffer.length) flushTable();
                    }

                    if (trimmed === '') return;

                    // Headings
                    let match = line.match(/^(#{1,4}) (.*)/);
                    if (match) {
                        html += `<h${match[1].length} data-line="${lineNum}">${this.inlineParse(match[2])}</h${match[1].length}>`;
                        return;
                    }
                    
                    // HR
                    if (trimmed === '---') {
                        html += `<hr data-line="${lineNum}">`;
                        return;
                    }

                    // Blockquote
                    if (line.startsWith('>')) {
                        // Allow "> " or ">"
                        let content = line.substring(1);
                        if (content.startsWith(' ')) content = content.substring(1);
                        html += `<blockquote data-line="${lineNum}">${this.inlineParse(content)}</blockquote>`;
                        return;
                    }
                    
                    // Images/Block Elements
                    if (line.match(/^!\[.*\]\(.*\)$/)) {
                        html += `<div data-line="${lineNum}">${this.inlineParse(line)}</div>`;
                        return;
                    }

                    html += `<p data-line="${lineNum}">${this.inlineParse(line)}</p>`;
                });
                
                if (listBuffer.length) flushList();
                if (tableBuffer.length) flushTable();
                if (inCodeBlock) { 
                     html += `<pre><code>${this.escapeHtml(codeBuffer.join('\n'))}</code></pre>`;
                }

                return html;
            },
            
            inlineParse: function(text) {
                return text
                    .replace(/`([^`]+)`/g, '<code>$1</code>')
                    .replace(/!\[(.*?)\]\((.*?)\)/g, '<img src="$2" alt="$1">')
                    .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^( {4})/g, '&emsp;&emsp;')
                    .replace(/<u>(.*?)<\/u>/g, '<u>$1</u>')
                    .replace(/<s>(.*?)<\/s>/g, '<s>$1</s>')
                    .replace(/<div class="text-(center|left|right|justify)">(.*?)<\/div>/g, '<div class="text-$1">$2</div>')
                    .replace(/<span style="color:(.*?)">(.*?)<\/span>/g, '<span style="color:$1">$2</span>');
            },
            
            escapeHtml: function(unsafe) {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
        };

        const app = {
            data: [], images: {}, viewMode: 'split', activeChapId: null, activeSecId: null,
            settings: { lineHeight: 1.6 },

            init() {
                const saved = localStorage.getItem('phonetic_doc_pro');
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        this.data = parsed.data || [];
                        this.images = parsed.images || {};
                        this.audios = parsed.audios || {};
                        this.settings = parsed.settings || { lineHeight: 1.6 };
                    } catch(e) {}
                }
                if (!this.data.length) this.addChapter(true);
                else {
                    this.activeChapId = this.data[0].id;
                    this.activeSecId = this.data[0].sections[0].id;
                }
                document.documentElement.style.setProperty('--doc-line-height', this.settings.lineHeight);
                document.getElementById('lineHeightRange').value = this.settings.lineHeight;
                document.getElementById('lineHeightValue').innerText = this.settings.lineHeight;
                this.render();
                this.setupEvents();
                setInterval(() => this.autoSaveJSON(), 600000);
            },

            setupEvents() {
                const ta = document.getElementById('markdownInput');
                
                // Sync Scroll: Editor -> Preview
                const syncFromEditor = () => {
                    const val = ta.value.substring(0, ta.selectionStart);
                    const lineNum = val.split('\n').length;
                    const el = document.querySelector(`[data-line="${lineNum}"]`);
                    if (el) {
                        el.scrollIntoView({behavior: 'smooth', block: 'center'});
                        document.querySelectorAll('.sync-active').forEach(e => e.classList.remove('sync-active'));
                        el.classList.add('sync-active');
                        setTimeout(() => el.classList.remove('sync-active'), 2000);
                    }
                };

                ta.addEventListener('input', (e) => {
                    const sec = this.getCurrentSection();
                    if(sec) {
                        sec.content = e.target.value;
                        this.updatePreview(sec.content);
                        localStorage.setItem('phonetic_doc_pro', JSON.stringify({ data:this.data, images:this.images, audios:this.audios, settings: this.settings }));
                    }
                });
                
                ta.addEventListener('click', syncFromEditor);
                ta.addEventListener('keyup', (e) => {
                    if(e.key.startsWith('Arrow')) syncFromEditor();
                });

                ta.addEventListener('paste', (e) => {
                    const cd = e.clipboardData || window.clipboardData;
                    if(!cd) return;
                    if(cd.files && cd.files.length) {
                        const f = cd.files[0];
                        if(f && f.type && f.type.startsWith('image/')) { e.preventDefault(); this.handleFile(f, 'image'); }
                        else if(f && f.type && f.type.startsWith('audio/')) { e.preventDefault(); this.handleFile(f, 'audio'); }
                        return;
                    }
                    if(cd.items && cd.items.length) {
                        for(let i=0;i<cd.items.length;i++) {
                            const item = cd.items[i];
                            if(item && item.kind === 'file') {
                                if(item.type.startsWith('image/')) {
                                    e.preventDefault();
                                    const file = item.getAsFile();
                                    if(file) this.handleFile(file, 'image');
                                    return;
                                } else if(item.type.startsWith('audio/')) {
                                    e.preventDefault();
                                    const file = item.getAsFile();
                                    if(file) this.handleFile(file, 'audio');
                                    return;
                                }
                            }
                        }
                    }
                    const htmlData = cd.getData && cd.getData('text/html');
                    if(htmlData) {
                        const div = document.createElement('div');
                        div.innerHTML = htmlData;
                        const img = div.querySelector('img');
                        if(img && img.src && img.src.startsWith('data:image/')) {
                            e.preventDefault();
                            const blob = this.dataURItoBlob(img.src);
                            this.handleFile(blob, 'image');
                            return;
                        }
                    }
                });

                ta.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        if (e.key.toLowerCase() === 's') {
                            e.preventDefault();
                            this.downloadJSON(); 
                            return;
                        }
                        switch(e.key.toLowerCase()) {
                            case 'b': e.preventDefault(); this.insertFormat('**', '**'); break;
                            case 'i': e.preventDefault(); this.insertFormat('*', '*'); break;
                            case 'u': e.preventDefault(); this.insertFormat('<u>', '</u>'); break;
                            case 'd': e.preventDefault(); this.insertFormat('<s>', '</s>'); break;
                            case 'k': e.preventDefault(); this.insertFormat('[', '](url)'); break;
                            case 'e': e.preventDefault(); this.insertFormat('<div class="text-center">', '</div>'); break;
                            case 'l': e.preventDefault(); this.insertFormat('<div class="text-left">', '</div>'); break;
                            case 'r': e.preventDefault(); this.insertFormat('<div class="text-right">', '</div>'); break;
                            case 'j': e.preventDefault(); this.insertFormat('<div class="text-justify">', '</div>'); break;
                        }
                    }
                    if (e.altKey) {
                         if(e.key === '1') { e.preventDefault(); this.toggleLinePrefix('# '); }
                         if(e.key === '2') { e.preventDefault(); this.toggleLinePrefix('## '); }
                         if(e.key === '3') { e.preventDefault(); this.toggleLinePrefix('### '); }
                    }
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        document.execCommand('insertText', false, '    ');
                    }
                });

                // Sync Scroll: Preview -> Editor
                document.getElementById('previewContent').addEventListener('click', (e) => {
                    const target = e.target.closest('[data-line]');
                    if(target) {
                        const lineNum = parseInt(target.getAttribute('data-line'));
                        this.scrollToLineInEditor(lineNum);
                    }
                });

                const zone = document.getElementById('workspace');
                const overlay = document.getElementById('dragOverlay');
                zone.addEventListener('dragover', (e) => { e.preventDefault(); overlay.classList.add('active'); });
                overlay.addEventListener('dragleave', () => overlay.classList.remove('active'));
                overlay.addEventListener('drop', (e) => {
                    e.preventDefault(); overlay.classList.remove('active');
                    if(e.dataTransfer.files.length) {
                        const f = e.dataTransfer.files[0];
                        if(f.type.startsWith('image/')) this.handleFile(f, 'image');
                        else if(f.type.startsWith('audio/')) this.handleFile(f, 'audio');
                    }
                });
            },
            
            scrollToLineInEditor(lineNum) {
                const ta = document.getElementById('markdownInput');
                const lines = ta.value.split('\n');
                if(lineNum > lines.length) return;
                
                let pos = 0;
                for(let i=0; i<lineNum-1; i++) {
                    pos += lines[i].length + 1; 
                }
                
                ta.focus();
                ta.setSelectionRange(pos, pos + lines[lineNum-1].length);
                
                const lineHeight = 24; 
                const totalLines = lines.length;
                if(totalLines > 0) {
                     const percent = (lineNum - 1) / totalLines;
                     ta.scrollTop = ta.scrollHeight * percent - ta.clientHeight / 2;
                }
            },
            
            toggleLinePrefix(prefix) {
                 this.insertFormat(prefix, '');
            },

            insertFormat(prefix, suffix) {
                const ta = document.getElementById('markdownInput');
                ta.focus();
                const start = ta.selectionStart;
                const end = ta.selectionEnd;
                if (document.queryCommandSupported('insertText')) {
                    const text = ta.value.substring(start, end);
                    document.execCommand('insertText', false, prefix + text + suffix);
                } else {
                    ta.setRangeText(prefix + ta.value.substring(start, end) + suffix, start, end, 'select');
                }
            },

            applyColor(color) {
                this.insertFormat(`<span style="color:${color}">`, `</span>`);
            },

            updateLineHeight(val) {
                this.settings.lineHeight = val;
                document.getElementById('lineHeightValue').innerText = val;
                document.documentElement.style.setProperty('--doc-line-height', val);
            },

            getCurrentSection() {
                const chap = this.data.find(c => c.id === this.activeChapId);
                return chap?.sections.find(s => s.id === this.activeSecId);
            },

            render() {
                this.renderSidebar();
                this.renderWorkspace();
            },

            renderSidebar() {
                const container = document.getElementById('chapterList');
                container.innerHTML = '';
                this.data.forEach(chap => {
                    const chapDiv = document.createElement('div');
                    chapDiv.className = 'chapter-item';
                    const header = document.createElement('div');
                    header.className = 'chapter-header';
                    header.innerHTML = `
                        <input type="text" class="chapter-title" value="${chap.title}" oninput="app.updateTitle('${chap.id}', this.value, true)">
                        <div class="chapter-actions" style="display:flex; gap:4px;">
                            <button class="btn-icon" onclick="app.addSection('${chap.id}')">＋</button>
                            <button class="btn-icon delete" onclick="app.delChapter('${chap.id}')">×</button>
                        </div>`;
                    const secList = document.createElement('div');
                    secList.className = 'section-list';
                    chap.sections.forEach(sec => {
                        const secDiv = document.createElement('div');
                        secDiv.className = `section-item ${sec.id === this.activeSecId ? 'active' : ''}`;
                        secDiv.onclick = () => { this.activeChapId = chap.id; this.activeSecId = sec.id; this.render(); };
                        secDiv.innerHTML = `<span>${sec.title}</span><button class="btn-icon delete section-actions" onclick="event.stopPropagation(); app.delSection('${chap.id}', '${sec.id}')">×</button>`;
                        secList.appendChild(secDiv);
                    });
                    chapDiv.appendChild(header);
                    chapDiv.appendChild(secList);
                    container.appendChild(chapDiv);
                });
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-dashed';
                addBtn.innerText = '+ 新建章节';
                addBtn.onclick = () => this.addChapter();
                container.appendChild(addBtn);
            },

            renderWorkspace() {
                const sec = this.getCurrentSection();
                const chap = this.data.find(c => c.id === this.activeChapId);
                const ta = document.getElementById('markdownInput');
                if (!sec) {
                    ta.value = '';
                    document.getElementById('previewContent').innerHTML = '<div style="text-align:center;color:#cbd5e1;margin-top:100px">请选择小节</div>';
                    return;
                }
                document.getElementById('headerChapTitle').innerText = chap.title;
                document.getElementById('headerSecTitle').value = sec.title;
                document.getElementById('headerSecTitle').oninput = (e) => this.updateTitle(sec.id, e.target.value, false);
                if (ta.value !== sec.content) ta.value = sec.content;
                this.updatePreview(sec.content);
            },

            updatePreview(content) {
                let html = content.replace(/!\[(.*?)\]\((img_[a-z0-9]+)\)/g, (m, alt, id) => this.images[id] ? `![${alt}](${this.images[id]})` : m);
                html = html.replace(/!\[audio\]\((aud_[a-z0-9]+)\)/g, (m, id) => this.audios[id] ? `<audio controls src="${this.audios[id]}"></audio>` : m);
                document.getElementById('previewContent').innerHTML = SimpleMD.parse(html);
            },

            updateTitle(id, val, isChap) {
                if (isChap) this.data.find(c => c.id === id).title = val;
                else {
                    const chap = this.data.find(c => c.id === this.activeChapId);
                    chap.sections.find(s => s.id === id).title = val;
                    this.renderSidebar(); 
                }
            },

            addChapter(isInit) {
                const id = 'c' + Date.now();
                this.data.push({ id, title: '新章节', sections: [{ id: 's'+Date.now(), title: '新小节', content: '' }] });
                if(!isInit) { this.activeChapId = id; this.activeSecId = this.data[this.data.length-1].sections[0].id; this.render(); }
            },
            
            addSection(chapId) {
                const chap = this.data.find(c => c.id === chapId);
                const id = 's' + Date.now();
                chap.sections.push({ id, title: '新小节', content: '' });
                this.activeChapId = chapId; this.activeSecId = id;
                this.render();
            },

            delChapter(id) {
                if(confirm('删除此章？') && this.data.length > 1) {
                    this.data = this.data.filter(c => c.id !== id);
                    this.activeChapId = this.data[0].id; this.activeSecId = this.data[0].sections[0].id;
                    this.render();
                }
            },

            delSection(chapId, secId) {
                const chap = this.data.find(c => c.id === chapId);
                if(chap.sections.length > 1 && confirm('删除此节？')) {
                    chap.sections = chap.sections.filter(s => s.id !== secId);
                    this.activeSecId = chap.sections[0].id;
                    this.render();
                }
            },

            setView(mode) {
                this.viewMode = mode;
                ['Split', 'Edit', 'Preview'].forEach(m => document.getElementById('btn'+m).classList.toggle('active', m.toLowerCase()===mode));
                const editor = document.getElementById('paneEditor');
                const preview = document.getElementById('panePreview');
                editor.classList.remove('hidden'); preview.classList.remove('hidden');
                if (mode === 'edit') preview.classList.add('hidden');
                if (mode === 'preview') editor.classList.add('hidden');
            },

            handleImage(file) {
                this.handleFile(file, 'image');
            },

            handleFile(file, type) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    if (type === 'image') {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let w = img.width, h = img.height;
                            if(w>1200) { h = h*1200/w; w=1200; }
                            canvas.width=w; canvas.height=h;
                            canvas.getContext('2d').drawImage(img,0,0,w,h);
                            const id = 'img_' + Math.random().toString(36).substr(2,9);
                            this.images[id] = canvas.toDataURL('image/jpeg', 0.85);
                            document.execCommand('insertText', false, `\n![img](${id})\n`);
                        };
                        img.src = e.target.result;
                    } else if (type === 'audio') {
                        const id = 'aud_' + Math.random().toString(36).substr(2,9);
                        this.audios[id] = e.target.result;
                        document.execCommand('insertText', false, `\n![audio](${id})\n`);
                    }
                };
                reader.readAsDataURL(file);
            },

            dataURItoBlob(uri) {
                const parts = uri.split(',');
                const mime = parts[0].split(':')[1].split(';')[0];
                const bstr = atob(parts[1]);
                const n = bstr.length;
                const u8 = new Uint8Array(n);
                for(let i=0;i<n;i++) u8[i] = bstr.charCodeAt(i);
                return new Blob([u8], { type: mime });
            },

            showMsg(txt) {
                const el = document.getElementById('msgToast');
                el.innerText = txt; el.classList.add('show');
                setTimeout(()=>el.classList.remove('show'), 2000);
            },
            
            downloadJSON() {
                const blob = new Blob([JSON.stringify({data:this.data, images:this.images, audios:this.audios, settings: this.settings})], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = 'PhoneticDoc_Backup.json'; a.click();
                this.showMsg('已下载备份');
            },

            autoSaveJSON() {
                const blob = new Blob([JSON.stringify({data:this.data, images:this.images, audios:this.audios, settings: this.settings})], {type:'application/json'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = 'PhoneticDoc_AutoSave.json'; a.click();
                this.showMsg('自动保存已完成');
            },
            
            loadJSON(input) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const p = JSON.parse(e.target.result);
                        if(p.data) { 
                            this.data=p.data; 
                            this.images=p.images||{}; 
                            this.audios=p.audios||{}; 
                            this.settings=p.settings||{lineHeight:1.6};
                            this.updateLineHeight(this.settings.lineHeight);
                            document.getElementById('lineHeightRange').value = this.settings.lineHeight;
                            this.activeChapId=this.data[0].id; 
                            this.activeSecId=this.data[0].sections[0].id; 
                            this.render(); 
                            this.showMsg('已恢复'); 
                        }
                    } catch(err) { alert('格式错误'); }
                };
                if(input.files[0]) reader.readAsText(input.files[0]);
                input.value = '';
            },

            exportHTML() {
                const sidebarHtml = this.data.map(c => `
                    <div class="chapter-item">
                        <div class="chapter-header"><span class="chapter-title">${c.title}</span></div>
                        <div class="section-list">
                            ${c.sections.map(s => `
                                <a href="#${s.id}" class="section-item" style="text-decoration:none"><span>${s.title}</span></a>
                            `).join('')}
                        </div>
                    </div>
                `).join('');

                const contentHtml = this.data.map(c => `
                    <div class="export-chapter-block">
                        <h1 class="chapter-main-title">${c.title}</h1>
                        ${c.sections.map(s => {
                            let content = s.content;
                            content = content.replace(/!\[audio\]\((aud_[a-z0-9]+)\)/g, (m, id) => this.audios[id] ? `<audio controls src="${this.audios[id]}"></audio>` : m);
                            let html = SimpleMD.parse(content);
                            html = html.replace(/src="(img_[a-z0-9]+)"/g, (m, id) => this.images[id] ? `src="${this.images[id]}"` : m);
                            return `<div id="${s.id}" class="section-block"><h2 class="section-title-anchor">${s.title}</h2>${html}</div><hr style="border:0; border-top:1px dashed #e2e8f0; margin: 40px 0;">`;
                        }).join('')}
                    </div>
                `).join('');

                const styleContent = document.querySelector('style').innerHTML;

                const html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PhoneticDoc Export</title>
<style>
    ${styleContent}
    :root { --doc-line-height: ${this.settings.lineHeight}; --block-margin: 0.6em; }
    
    body { height: auto; overflow: auto; display: flex; flex-direction: row; }
    .sidebar { position: fixed; height: 100vh; top: 0; left: 0; width: 280px; overflow-y: auto; z-index: 100; }
    .sidebar-footer { display: none; }
    .chapter-title { pointer-events: none; }
    
    .workspace { margin-left: 280px; width: calc(100% - 280px); display: block; min-height: 100vh; background: #f8fafc; }
    .topbar, .editor-container { display: none; }
    
    .export-container { max-width: 900px; margin: 0 auto; padding: 40px; }
    .paper-sheet { min-height: auto; margin-bottom: 40px; max-width: 100%; box-shadow: none; }
    
    .chapter-main-title { font-size: 2.5em; color: var(--primary); margin-top: 60px; border-bottom: none; text-align: center; }
    .section-title-anchor { margin-top: 0; padding-top: 20px; color: var(--text-main); font-size: 1.8em; }

    @media (max-width: 900px) {
        body { flex-direction: column; }
        .sidebar { position: relative; width: 100%; height: auto; max-height: 300px; border-right: none; border-bottom: 1px solid #e2e8f0; }
        .workspace { margin-left: 0; width: 100%; }
        .export-container { padding: 20px; }
        .paper-sheet { padding: 30px 20px; }
    }
    @media print {
        .sidebar { display: none; }
        .workspace { margin: 0; width: 100%; }
        .paper-sheet { padding: 0; }
    }
</style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">PhoneticDoc <span style="font-size:0.6em; margin-left:10px; color:#94a3b8; font-weight:normal">Export</span></div>
        <div class="sidebar-content">${sidebarHtml}</div>
    </aside>
    <main class="workspace">
        <div class="export-container">
            <div class="paper-sheet"><div class="markdown-body">${contentHtml}</div></div>
            <div style="text-align:center; color:#cbd5e1; margin-top:50px; font-size:0.9rem;">Generated by PhoneticDoc</div>
        </div>
    </main>
</body>
</html>`;
                const blob = new Blob([html], {type: 'text/html'});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                a.download = `Phonetic_Export_${new Date().toISOString().slice(0,10)}.html`;
                a.click();
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
